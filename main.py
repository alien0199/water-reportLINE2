import os
import requests
from bs4 import BeautifulSoup
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from PIL import Image, ImageDraw, ImageFont

def initialize_driver():
    opts = Options()
    opts.add_argument("--headless")
    opts.add_argument("--no-sandbox")
    opts.add_argument("--disable-dev-shm-usage")
    opts.add_argument("user-agent=Mozilla/5.0")
    return webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=opts)

def get_chao_phraya_dam_data():
    url = 'https://tiwrm.hii.or.th/DATA/REPORT/php/chart/chaopraya/small/chaopraya.php'
    driver = initialize_driver()
    try:
        driver.get(url)
        WebDriverWait(driver, 30).until(
            EC.presence_of_element_located((By.XPATH, "//*[contains(text(), '‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤')]"))
        )
        soup = BeautifulSoup(driver.page_source, "html.parser")
        strong_tag = soup.find('strong', string=lambda t: t and '‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤' in t)
        if strong_tag:
            table = strong_tag.find_parent('table')
            td = table.find('td', string=lambda t: t and '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥' in t)
            if td:
                value = td.find_next_sibling('td').text.strip().split('/')[0]
                print(f"‚úÖ Dam discharge raw value: {value}")
                return str(int(float(value)))
    except Exception as e:
        print("‚ùå Dam error:", e)
    finally:
        driver.quit()
    return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"

def get_inburi_bridge_data():
    url = "https://singburi.thaiwater.net/wl"
    driver = initialize_driver()
    try:
        driver.get(url)
        WebDriverWait(driver, 30).until(
            EC.presence_of_element_located((By.CSS_SELECTOR, "th[scope='row']"))
        )
        soup = BeautifulSoup(driver.page_source, "html.parser")
        for th in soup.select("th[scope='row']"):
            if "‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ö‡∏∏‡∏£‡∏µ" in th.get_text(strip=True):
                value = th.find_parent("tr").find_all("td")[1].get_text(strip=True)
                print(f"‚úÖ Water level @Inburi: {value}")
                return value
        print("‚ùå '‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ö‡∏∏‡∏£‡∏µ' not found in table")
    except Exception as e:
        print("‚ùå Inburi error:", e)
    finally:
        driver.quit()
    return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"

def get_weather_status():
    api_key = os.getenv("OPENWEATHER_API_KEY")
    if not api_key:
        print("‚ùå OPENWEATHER_API_KEY not found in environment")
        return "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°"
    lat, lon = "14.9", "100.4"
    url = f"https://api.openweathermap.org/data/2.5/weather?lat={lat}&lon={lon}&appid={api_key}&lang=th&units=metric"
    try:
        print("üì° Fetching weather from:", url)
        res = requests.get(url)
        data = res.json()
        print("‚úÖ Weather API response:", data)
        desc = data["weather"][0]["description"]
        emoji = "üåßÔ∏è" if "‡∏ù‡∏ô" in desc else "‚õÖ" if "‡πÄ‡∏°‡∏Ü" in desc else "‚òÄÔ∏è"
        return f"{desc.capitalize()} {emoji}"
    except Exception as e:
        print("‚ùå Weather fetch error:", e)
        return "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°"

def create_report_image(dam_discharge, water_level, weather_status):
    if not os.path.exists("background.png"):
        print("‚ùå background.png not found")
        return

    image = Image.open("background.png").convert("RGBA")
    draw = ImageDraw.Draw(image)

    lines = [
        f"‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ ‡∏ì ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ö‡∏∏‡∏£‡∏µ: {water_level} ‡∏°.",
        f"‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤: {dam_discharge} ‡∏•‡∏ö.‡∏°./‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ",
        f"‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®: {weather_status}"
    ]

    font_path = "Sarabun-Bold.ttf" if os.path.exists("Sarabun-Bold.ttf") else "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf"
    font = ImageFont.truetype(font_path, 34)

    # ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: x = 60 to 710, y = 125 to 370
    box_left, box_right = 60, 710
    box_top, box_bottom = 125, 370
    box_width = box_right - box_left
    box_height = box_bottom - box_top

    line_spacing = 15
    text_heights = [draw.textbbox((0, 0), l, font=font)[3] for l in lines]
    total_height = sum(text_heights) + line_spacing * (len(lines) - 1)
    y = box_top + (box_height - total_height) / 2

    for i, line in enumerate(lines):
        text_w = draw.textbbox((0, 0), line, font=font)[2]
        x = box_left + (box_width - text_w) / 2
        draw.text((x, y), line, font=font, fill="#003f5c", stroke_width=1, stroke_fill="white")
        y += text_heights[i] + line_spacing

    image.convert("RGB").save("final_report.jpg", "JPEG", quality=95)
    print("‚úÖ final_report.jpg created")

if __name__ == "__main__":
    print("üîÅ Updating water report...")
    dam_value = get_chao_phraya_dam_data()
    water_value = get_inburi_bridge_data()
    weather = get_weather_status()
    print(f"üìä ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: {water_value} | ‡πÄ‡∏Ç‡∏∑‡πà‡∏≠‡∏ô: {dam_value} | ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®: {weather}")
    create_report_image(dam_value, water_value, weather)
